# Release R22.2 — Slack + Scheduler set-and-forget + ORATS clarity

**Date:** 2026-02  
**Goal:** Operator can leave the dashboard running and trust scheduler + Slack; ORATS freshness states (OK/DELAYED/WARN/ERROR) clear; EVAL_SUMMARY to daily with throttle.

---

## Scope

- **In scope:** System Status shows per-channel Slack (last_send_at, last_send_ok, last_error, last_payload_type for signals, daily, data_health, critical) and full scheduler fields (last_run_at, last_duration_ms, last_run_ok, last_run_error, run_count_today, last_skip_reason); ORATS freshness OK/DELAYED/WARN/ERROR with documented thresholds; EVAL_SUMMARY to daily once per completed run with EVAL_SUMMARY_EVERY_N_TICKS throttle; Force eval always sends; no crash when Slack webhook missing.
- **Out of scope:** New Slack channels or payload types; decision JSON changes.

---

## API changes

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/ui/system-health` | Already included: `scheduler` (last_run_at, last_duration_ms, last_run_ok, last_run_error, run_count_today, last_skip_reason), `slack.channels` (signals, daily, data_health, critical each with last_send_at, last_send_ok, last_error, last_payload_type), `orats.orats_freshness_state`, `orats.orats_freshness_state_label`. R22.2: `orats.orats_as_of` (effective timestamp ISO), `orats.orats_threshold_triggered` (`ok_minutes` \| `warn_minutes` \| `error`). Fallback when Slack status unavailable returns `channels` with all four channels for consistent shape. |

ORATS policy (env): `ORATS_OK_MINUTES` (default 15) = OK; `ORATS_WARN_MINUTES` (default 30) = beyond this WARN; between = DELAYED. ERROR when no successful timestamp or API failure.

EVAL_SUMMARY throttle: `EVAL_SUMMARY_EVERY_N_TICKS` (default 1). Scheduler runs only; Force evaluation always sends one EVAL_SUMMARY to daily.

---

## UI changes

- System Status: ORATS card shows Freshness, as_of (ET), and Threshold (mapped from `orats_threshold_triggered`: "Within OK window", "Staleness threshold", "Error (no data or failure)"). Scheduler card shows all required fields; `last_skip_reason` shown with friendly labels (e.g. "Market closed — scheduler skips until open"; no raw codes). Slack card shows per-channel blocks and test buttons. Missing webhook shows "Not configured" (no crash).

---

## Data / persistence

- No change to decision store. `out/slack_status.json` and scheduler in-memory state unchanged in schema.

---

## Tests

- **Backend:** `test_orats_freshness_r222.py` — get_orats_freshness_state OK/DELAYED/WARN/ERROR; system-health orats block; system-health slack.channels per-channel shape. `test_ui_r21_5_notifications_slack_scheduler.py` — slack and scheduler fields.
- **Frontend:** SystemDiagnosticsPage tests (Slack and Scheduler sections).

---

## Verification

- **UAT evidence path:** `out/verification/R22.2/notes.md`.
- **Manual:** Slack test per channel; Force eval → EVAL_SUMMARY to daily; scheduler run → status updates; missing webhook → "Not configured".

---

## File list (summary)

- `chakraops/app/api/ui_routes.py` — _get_slack_status_health returns channels on exception for consistent API.
- `chakraops/app/api/data_health.py` — get_orats_freshness_state (existing); orats_freshness_state in system-health (existing).
- `chakraops/tests/test_orats_freshness_r222.py` — test_system_health_slack_channels_r222 added.
- `frontend/src/pages/SystemDiagnosticsPage.tsx` — ORATS/Scheduler/Slack sections (existing).
- `out/verification/R22.2/notes.md` — verification notes.
