# Release R21.1 — Account + Holdings (Phase 21.1)

**Date:** 2026-02-17  
**Goal:** SQLite-backed account profile, balances, and manual holdings; wire holdings into CC eligibility; Account & Portfolio UI.

---

## Scope

- **In scope:** SQLite tables (`account_profile`, `account_balances`, `holdings`), backend store and API under `/api/ui/account/*`, CC eligibility using holdings (≥100 shares), frontend Account & Portfolio page with Balances and Holdings sections.
- **Out of scope:** Multi-account, broker sync, watchlist_symbols table, changes to decision JSON persistence (remains code-only).

---

## API changes

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/ui/account/summary` | Returns `account_id`, `name`, `broker`, `base_currency`, `cash`, `buying_power`, `holdings_count`, `profile_updated_at`, `balances_updated_at`. |
| GET | `/api/ui/account/holdings` | Returns `{ "holdings": [ { "symbol", "shares", "avg_cost", "source", "updated_at" } ] }`. |
| POST | `/api/ui/account/holdings` | Body: `symbol` (required), `shares` (required), `avg_cost` (optional). Returns `{ "holding": { ... } }`. |
| DELETE | `/api/ui/account/holdings/{symbol}` | Removes holding. Returns `{ "deleted": true, "symbol": "..." }`. 404 if not found. |
| POST | `/api/ui/account/balances` | Body: `cash`, `buying_power` (at least one required). Returns `{ "summary": { ... } }`. |

All require `x-ui-key` header when `UI_API_KEY` is set.

---

## DB changes

- **New DB file:** `out/account.db` (path from `get_output_dir()`).
- **Tables:** `account_profile` (id, name, broker, base_currency, created_at, updated_at), `account_balances` (account_id, cash, buying_power, updated_at), `holdings` (account_id, symbol, shares, avg_cost, source, updated_at). Single default account id `"default"`; `init_db()` creates tables and default profile/balances if missing.

---

## UI changes

- **Portfolio** page renamed to **Account & Portfolio** (sidebar and page title).
- **Balances (manual):** Card showing cash and buying_power with Edit → form (Save/Cancel).
- **Holdings:** Card with table (symbol, shares, avg_cost, updated_at, Remove); "Add holding" form (symbol, shares, avg_cost optional).
- **Positions** section unchanged.

---

## Tests added

- **Backend:** `chakraops/tests/api/test_ui_account_r21.py` — GET summary structure, GET holdings list, POST holdings upsert + DELETE, POST validation (400), POST balances.
- **Backend:** `chakraops/tests/_core/test_eligibility_phase4.py` — `test_cc_holdings_gate_passes_with_100_shares`: with `holdings={"T": 100}`, rejection list does not contain `FAIL_NO_HOLDINGS` or `FAIL_NOT_HELD_FOR_CC`.
- **Frontend:** `frontend/src/pages/PortfolioPage.test.tsx` — mocks for `useAccountSummary`, `useAccountHoldings`, `useSetBalances`, `useUpsertHolding`, `useDeleteHolding`; test "shows Balances (manual) and Holdings sections (Phase 21.1)"; title test updated to "Account & Portfolio".

---

## Manual verification steps

1. Start backend and frontend; open **Account & Portfolio**.
2. **Balances:** Click Edit, set cash and buying power, Save; confirm values persist after refresh.
3. **Holdings:** Add a holding (e.g. NVDA, 225 shares, avg cost 95); confirm row appears; edit by adding same symbol with different shares/avg_cost; delete holding; confirm 404 on DELETE for unknown symbol if tested via API.
4. **API:** `GET /api/ui/account/summary`, `GET /api/ui/account/holdings`, `POST /api/ui/account/holdings`, `POST /api/ui/account/balances` (with valid body); confirm response shapes match types.
5. **CC eligibility:** Run evaluation with a symbol that has ≥100 shares in holdings; confirm decision does not show FAIL_NO_HOLDINGS for that symbol due to holdings (other gates may still apply).

---

## File list

- `chakraops/app/core/accounts/holdings_db.py` — SQLite store, init_db, get_account_summary, set_balances, list_holdings, upsert_holding, delete_holding, get_holdings_for_evaluation.
- `chakraops/app/core/eligibility/eligibility_engine.py` — CC_MIN_SHARES, held_ok_cc, rule_checks/rejections/cc_eligible using holdings.
- `chakraops/app/core/eval/staged_evaluator.py` — Load holdings, pass into evaluate_symbol_full.
- `chakraops/app/api/ui_routes.py` — GET/POST/DELETE account/summary, holdings, balances.
- `chakraops/tests/api/test_ui_account_r21.py` — Account API tests.
- `chakraops/tests/_core/test_eligibility_phase4.py` — test_cc_holdings_gate_passes_with_100_shares.
- `frontend/src/api/types.ts` — AccountSummary, AccountHolding, AccountHoldingsResponse.
- `frontend/src/api/queries.ts` — Paths, query keys, useAccountSummary, useAccountHoldings, useSetBalances, useUpsertHolding, useDeleteHolding.
- `frontend/src/pages/PortfolioPage.tsx` — Account & Portfolio title, Balances card with edit form, Holdings table with add/remove.
- `frontend/src/layout/Sidebar.tsx` — Label "Account & Portfolio" for /portfolio.
- `frontend/src/pages/PortfolioPage.test.tsx` — Mocks and Phase 21.1 section test.

---

## Verification artifacts

- `out/verification/R21.1/notes.md` — Commands run and expected/actual.
- `out/verification/R21.1/api_samples/` — Sanitized JSON responses for account endpoints.
