# Release R21.4 — Symbol technical details panel (Phase 21.4)

**Date:** 2026-02  
**Goal:** Expose technical metrics at request time in the diagnostics API and show them in a Technical details panel on the Symbol/Diagnostics page. No persistence of computed_values; UI uses code-to-display mappings.

---

## Scope

- **In scope:** `computed_values` built at request time in GET `/api/ui/symbol-diagnostics`; Technical details panel on Symbol Diagnostics page (RSI, RSI range, ATR, ATR%, support/resistance, regime, delta band, rejected count); API contract and UI tests; release notes and verification.
- **Out of scope:** Decision JSON schema changes; persistence of computed_values; new SQLite or any new persisted store; free-text reasons in UI (labels from mappings only).

---

## API changes

| Method | Path | Change |
|--------|------|--------|
| GET | `/api/ui/symbol-diagnostics?symbol={sym}` | Response now includes **`computed_values`** (request-time only, not persisted). |

**`computed_values` shape:**

- `rsi`, `atr`, `atr_pct`, `support_level`, `resistance_level`, `regime` — from existing diagnostics (technicals + summary).
- `rsi_range` — `[CSP_RSI_MIN, CSP_RSI_MAX]` from eligibility config (e.g. `[40, 60]`).
- `delta_band` — `[CSP_TARGET_DELTA_LOW, CSP_TARGET_DELTA_HIGH]` from trade_rules (e.g. `[0.25, 0.35]`).
- `rejected_count` — length of `sample_rejected_due_to_delta` (sample count).

Data dependency rules unchanged: required data missing → BLOCKED; API derives from existing store only.

---

## UI changes

- **Symbol Diagnostics page:** "Technical details" panel (left column) shows:
  - RSI, RSI range, ATR, ATR%, Support, Resistance, Regime, Delta band, Rejected count.
  - All labels are safe (e.g. "RSI", "Delta band", "Rejected count"); no raw `FAIL_*` codes in this panel.

---

## Tests added

- **Backend:** `chakraops/tests/test_computed_values_r214.py` — `_build_computed_values_at_request_time` deterministic output; missing technicals; GET symbol-diagnostics response includes `computed_values` with expected keys.
- **Frontend:** `SymbolDiagnosticsPage.score.test.tsx` — "R21.4 Technical details panel": panel renders with expected fields and safe labels; no raw FAIL_* in panel.

---

## Manual verification steps

1. Run backend and open Symbol Diagnostics; enter **NVDA** (or a symbol in your store) and Lookup.
2. Confirm "Technical details" panel shows RSI, RSI range, ATR, ATR%, Support, Resistance, Regime, Delta band, Rejected count with numeric values or "—" when missing.
3. Confirm no raw reason codes (e.g. `FAIL_RSI_RANGE`) appear in the Technical details panel.
4. Confirm `decision_latest.json` (and any artifact) does **not** contain a `computed_values` key.

---

## Decision JSON

- **Unchanged.** `computed_values` is computed only when building the API response in `_build_symbol_diagnostics_from_v2_store` and is never written to the artifact or store.

---

## File list

- `chakraops/app/api/ui_routes.py` — `_build_computed_values_at_request_time()`, `computed_values` in symbol-diagnostics response.
- `chakraops/tests/test_computed_values_r214.py` — New: 3 backend tests.
- `frontend/src/api/types.ts` — `SymbolDiagnosticsComputedValues`, `computed_values` on extended response.
- `frontend/src/pages/SymbolDiagnosticsPage.tsx` — Technical details panel using `computed_values`; wrapper `data-testid="technical-details-panel"`.
- `frontend/src/pages/SymbolDiagnosticsPage.score.test.tsx` — R21.4 Technical details panel tests.
- `chakraops/docs/releases/R21.4_release_notes.md` — This file.
- `chakraops/docs/releases/RELEASE_CHECKLIST.md` — R21.4 items marked done.
- `out/verification/R21.4/notes.md` — Commands and results.
- `out/verification/R21.4/api_samples/symbol_diagnostics_nvda.json` — Sanitized sample response.
