# Phase 9: Market-aware health pipeline. Runs on schedule (ET); validates LIVE API; uploads report artifact.
# Set repository secret LIVE_API_BASE_URL (e.g. https://your-backend.example.com). No trailing slash.
name: Market Health

on:
  schedule:
    # Pre-market 08:45 ET (EST) = 13:45 UTC
    - cron: "45 13 * * 1-5"
    # Market open 09:35 ET = 14:35 UTC
    - cron: "35 14 * * 1-5"
    # Midday 12:30 ET = 17:30 UTC
    - cron: "30 17 * * 1-5"
    # Post-market 16:30 ET = 21:30 UTC
    - cron: "30 21 * * 1-5"
  workflow_dispatch:

env:
  LIVE_API_BASE_URL: ${{ secrets.LIVE_API_BASE_URL }}

jobs:
  health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set market phase
        id: phase
        run: |
          h=$(date -u +%H)
          m=$(date -u +%M)
          p=unknown
          [ "$h" = "13" ] && [ "$m" -ge "40" ] && p=pre
          [ "$h" = "14" ] && [ "$m" -ge "30" ] && p=open
          [ "$h" = "17" ] && [ "$m" -ge "25" ] && p=mid
          [ "$h" -ge "21" ] && p=post
          [ "$h" = "20" ] && [ "$m" -ge "30" ] && p=post
          echo "phase=$p" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        run: npm ci
        working-directory: frontend

      # Validates: healthz, daily-overview, positions, alerts, decision-history, universe, symbol-diagnostics?symbol=SPY, ops/status
      - name: Run market health check
        env:
          LIVE_API_BASE_URL: ${{ env.LIVE_API_BASE_URL }}
          MARKET_PHASE: ${{ steps.phase.outputs.phase }}
          ARTIFACTS_DIR: ${{ github.workspace }}/artifacts
        run: npx tsx scripts/market-health-check.ts
        working-directory: frontend

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: market_health_${{ github.run_number }}
          path: artifacts/market_health_*.json

  on-failure:
    runs-on: ubuntu-latest
    needs: health
    if: failure()
    steps:
      - name: Failure summary
        run: |
          echo "::error::Market health pipeline FAILED. Check the health job logs for endpoint status and validation warnings."
          echo "Common causes: LIVE_API_BASE_URL not set, backend down, timeout, or schema mismatch."
