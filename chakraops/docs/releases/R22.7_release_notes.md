# Release R22.7 — Truth + Consistency + Premium Symbol UX

**Date:** 2026-02  
**Goal:** Decision artifact code-only (no prose/FAIL_*); consistency, MTF S/R, targets, shares, ORATS labels, contract identity, and premium UX (full scope in requirements; Part 1 delivered).

---

## Scope

- **In scope (Part 1 — delivered):** Decision artifact hygiene. Persisted `out/decision_latest.json` and history files are code-only: no `primary_reason` or `why_this_trade` prose, no `band_reason`, no `FAIL_*`/`WARN_*` in values. New: `primary_reason_codes` (machine codes without FAIL_ prefix), `to_dict_persist()` strips prose; API derives display from codes at request time (`_primary_reason_display`, `_reason_code_to_label`). Backend test `test_decision_artifact_hygiene_r227.py` enforces no forbidden keys/patterns.
- **In scope (requirements doc):** Parts 2–9 (run vs recompute determinism, MTF S/R resampling, targets/hold-time, shares tab, technical details, ORATS labels, trade ticket contract identity, UX polish) — see `docs/releases/R22.7_requirements.md`. Implemented incrementally; Part 1 is complete.

---

## API changes

- **Decision / symbol responses:** `primary_reason` in API responses is now request-time computed from `primary_reason_codes` (safe labels; no raw FAIL_*). Response shape unchanged; values are human-readable labels.
- **Persisted artifact:** Written via `to_dict_persist()`. Symbols: `primary_reason_codes` (list), no `primary_reason`, no `band_reason`. Candidates: no `why_this_trade`. Gates: `name`, `status` only (no `reason`). Diagnostics: no `explanation` block.

---

## UI changes

- No raw FAIL_* or WARN_* in UI; backend sends safe labels. Existing Symbol/Universe/Diagnostics pages show `primary_reason` as before (now from code mapping).

---

## Data / persistence

- **decision_latest.json / out/decisions/**  
  - Persisted schema: `primary_reason_codes` per symbol; no `primary_reason`, `band_reason`, `why_this_trade`, gate `reason`, or diagnostics `explanation`.  
  - Backward compat: `from_dict` accepts legacy `primary_reason` and derives `primary_reason_codes`; in-memory `primary_reason` set to None when codes present so re-serialization stays code-only.

---

## Tests

- **Backend:** `tests/test_decision_artifact_hygiene_r227.py` — no forbidden keys (`why_this_trade`, `explanation`, etc.), no forbidden string patterns (`FAIL_*`, `WARN_*`, UI snippets) in decision artifact (minimal build and load-from-disk).
- **Frontend:** No new tests in this pass; existing tests remain valid.

---

## Verification and UAT

- **Commands:**  
  - Backend: `cd chakraops && python -m pytest tests/ -v --tb=short`  
  - Frontend: `cd frontend && npm run test -- --run`  
  - Build: `cd frontend && npm run build`
- **UAT evidence path:** `out/verification/R22.7/notes.md`
- **Manual:** Confirm decision_latest.json on disk has no `primary_reason`/`why_this_trade`/FAIL_*; API still returns readable `primary_reason` for UI.

---

## R22.7 Part 2 — Eval determinism

- **Unified pipeline:** `/api/ui/eval/run` and `/api/ui/symbols/{symbol}/recompute` (and GET symbol-diagnostics?recompute=1) all call the same core `run_universe_evaluation_staged`; same config and same evaluation logic.
- **As-of / Inputs (request-time only):** Symbol diagnostics response includes `as_of_inputs`: `evaluation_run_id`, `pipeline_timestamp`, `quote_as_of`, `candles_as_of`, `orats_as_of`, `config_hash`. Shown in Symbol Diagnostics UI so operators can confirm Universe vs Recompute used the same pipeline and compare timestamps.
- **Determinism test:** `tests/test_eval_determinism_r227.py` mocks staged result; asserts that when both paths receive the same staged output, score, band, verdict, and primary_reason_codes are identical.
- **Rule:** Both paths use latest data when run; differences (e.g. NKE B vs C) are due to data timing. Use "Recompute now" after Universe run to refresh a single symbol; As-of/Inputs section confirms which run and pipeline timestamp the view is from.

## R22.7 Part 3 — Real multi-timeframe S/R

- **OHLC resampling:** From daily candles (ORATS hist/dailies), weekly and monthly bars are derived: open=first, high=max, low=min, close=last, volume=sum. `build_weekly_from_daily` and `build_monthly_from_daily` in `app/core/regime.py`; list-of-dicts resampling in `app/core/eligibility/multiframe.py` (`_resample_daily_to_weekly`, `_resample_daily_to_monthly`).
- **S/R per timeframe:** At request time (symbol diagnostics), daily candles are fetched; weekly and monthly are resampled; support/resistance are computed per timeframe using existing `swing_cluster.compute_support_resistance` (fractal + ATR clustering). Each timeframe returns `support_level`, `resistance_level`, `as_of`, `bar_count`, `method`, `tolerance_used`. If insufficient history, `status_code="INSUFFICIENT_HISTORY"` and levels are null.
- **UI:** Multi-timeframe card shows timeframe rows with support, resistance, bar_count, as_of, method. When daily/weekly/monthly levels are identical and bar_count differs, a subtle request-time-only message is shown: "Levels coincide across timeframes; bar_count differs by resolution."

---

## Rollback notes

- Revert R22.7 commit(s). No DB migration. If rollback, re-run evaluation to regenerate decision artifact in old format only if frontend expects raw `primary_reason` again (current frontend uses display string).

---

## File list (summary)

- `chakraops/app/core/eval/decision_artifact_v2.py` — `primary_reason_codes`, `rejected_due_to_delta_count`, `_reason_string_to_codes_and_count`, `_STRICT_CODE_RE`, `to_dict_persist()` (strict codes, candidate contract_key derivation, diagnostics reason sanitization), `from_dict` backward compat.
- `chakraops/app/core/eval/evaluation_store_v2.py` — write via `to_dict_persist()`.
- `chakraops/app/core/eval/evaluation_service_v2.py` — `primary_reason_codes` and `rejected_due_to_delta_count` from `_reason_string_to_codes_and_count`; same pipeline for universe and recompute.
- `chakraops/app/api/ui_routes.py` — `_primary_reason_display`; As-of/Inputs (`as_of_inputs`, `_config_hash_for_diagnostics`); real MTF S/R (`_build_mtf_levels_at_request_time` with symbol, resampled weekly/monthly, bar_count, INSUFFICIENT_HISTORY).
- `chakraops/app/core/regime.py` — `build_monthly_from_daily`.
- `chakraops/app/core/eligibility/multiframe.py` — `_resample_daily_to_monthly`.
- `chakraops/tests/test_decision_artifact_hygiene_r227.py` — strict regex on primary_reason_codes, no prose substrings, `test_option_candidates_have_identity_fields`.
- `chakraops/tests/test_eval_determinism_r227.py` — same staged result → same score/band/verdict/primary_reason_codes.
- `frontend/src/api/types.ts` — `as_of_inputs`, MTF bar_count/status_code.
- `frontend/src/pages/SymbolDiagnosticsPage.tsx` — As-of/Inputs section; MTF table bar_count, INSUFFICIENT_HISTORY row, "levels coincide" message.
- `docs/releases/R22.7_requirements.md` — acceptance criteria status (A1–A10).
- `chakraops/docs/releases/RELEASE_CHECKLIST.md` — Part 1.1, 2, 3, 8 marked done.
- `out/verification/R22.7/notes.md` — gate outputs and UAT checklist.
