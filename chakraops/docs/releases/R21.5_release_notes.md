# Release R21.5 — Notifications lifecycle + Slack + Scheduler observability (Phase 21.5)

**Date:** 2026-02-17  
**Goal:** Notification states (NEW/ACKED/ARCHIVED), archive/delete/archive_all; Slack sender status and test message; Scheduler last_skip_reason and Force evaluation now.

---

## Summary

- **Notifications:** Lifecycle states (NEW, ACKED, ARCHIVED, DELETED) persisted via append-only state events in the existing notifications store. List supports `?state=NEW|ACKED|ARCHIVED`. Endpoints: ack (existing), archive, delete, archive_all.
- **Slack:** Slack sender status record (`last_send_at`, `last_send_ok`, `last_error`, `last_channel`, `last_payload_type`) in `out/slack_status.json`; exposed in System Status API and UI; admin test endpoint sends a test message and updates status.
- **Scheduler:** `last_skip_reason` captured when evaluation is skipped (market_closed, evaluation_running, no_symbols, etc.); exposed in System Status. Admin "Force evaluation now" runs one cycle immediately (bypasses market check) and returns `forced: true`.

---

## Scope

- **In scope:** Notification state + updated_at; POST archive, DELETE delete, POST archive_all; Slack status file + system-health + POST admin/slack/test; Scheduler last_skip_reason + GET system-health + POST admin/evaluation/force; Frontend: Notifications tabs/actions, bell dropdown NEW count + quick Ack/Archive, System Status Slack + Scheduler blocks and buttons.
- **Out of scope:** Decision JSON or artifact changes (code-only preserved); core strategy/selection logic unchanged.

---

## API changes

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/ui/notifications?limit=N&state=NEW\|ACKED\|ARCHIVED` | List notifications; each item has `state`, `updated_at`. |
| POST | `/api/ui/notifications/{id}/ack` | (Existing) Append ack event. |
| POST | `/api/ui/notifications/{id}/archive` | Append ARCHIVED state event. |
| DELETE | `/api/ui/notifications/{id}` | Append DELETED state event (soft; excluded from default list). |
| POST | `/api/ui/notifications/archive_all` | Archive all NEW/ACKED. Returns `{ status, archived_count }`. |
| GET | `/api/ui/system-health` | Now includes `scheduler.last_skip_reason`, `slack` (last_send_at, last_send_ok, last_error, etc.). |
| POST | `/api/ui/admin/slack/test` | Send test Slack message; update slack status. UI key required. |
| POST | `/api/ui/admin/evaluation/force` | Run one evaluation cycle immediately. Returns `{ status, started, run_id, reason, forced: true }`. UI key required. |

---

## Data model / store

- **Notifications:** Append-only JSONL. State events: `{ "event": "state", "ref_id", "state": "ACKED|ARCHIVED|DELETED", "updated_at" }`. Ack events unchanged. `load_notifications(limit, state_filter)` merges events and returns `state`, `updated_at` per notification; DELETED excluded unless filter=DELETED.
- **Slack status:** Single JSON file `out/slack_status.json` (or alongside decision store). Fields: last_send_at, last_send_ok, last_error, last_channel, last_payload_type. Updated by SlackNotifier on send and by admin test endpoint.
- **Scheduler:** In-memory `_last_scheduled_skip_reason` set in `_run_scheduled_evaluation()` when skipped; returned by `get_scheduler_status()` and system-health.

---

## UI changes

- **Notifications page:** Tabs NEW / ACKED / ARCHIVED / ALL; filter input; per-row Ack, Archive, Delete; Archive all button; State column; detail panel with same actions.
- **Bell dropdown (top-right):** NEW count badge; list of newest NEW notifications; quick Ack and Archive per item; "View all notifications" link.
- **System Status page:** Scheduler card shows `last_skip_reason`; new Slack card (last_send_at, last_send_ok, last_error, last_payload_type) with "Send test Slack" button; "Force evaluation now" button; result messages for test Slack and force eval.

---

## Tests

- **Backend:** `tests/test_ui_r21_5_notifications_slack_scheduler.py` — notification state/filter; ack/archive/delete/archive_all; GET/POST/DELETE endpoints; admin Slack test (mocked send) updates status; scheduler status includes last_skip_reason; system-health includes slack and last_skip_reason; admin force eval returns forced=True.
- **Frontend:** NotificationsPage — tabs, Archive all, per-row actions (Ack, Archive, Delete); detail Ack. SystemDiagnosticsPage — last_skip_reason, Slack card, Send test Slack, Force evaluation now.

---

## Manual verification steps

1. **Notifications:** Open Notifications page; switch tabs NEW/ACKED/ARCHIVED/ALL; create a test notification (e.g. POST /api/ui/notifications); Ack one, Archive one, Delete one; click Archive all; confirm counts and state column.
2. **Bell:** Ensure NEW count appears on bell; open dropdown; verify newest NEW list and Ack/Archive buttons; click Ack on one and confirm count decreases.
3. **System Status:** Open System Status; confirm Scheduler shows last_skip_reason (e.g. market_closed when closed); confirm Slack card shows last_send_at, last_send_ok; click "Send test Slack" (with or without webhook configured); click "Force evaluation now" and confirm response shows forced: true and started.
4. **Decision JSON:** Confirm `decision_latest.json` and archived decision files contain no `reasons_explained` or new human-readable fields; schema unchanged.

---

## Caveats

- Archive all appends one state event per NEW/ACKED notification; large lists may produce many writes.
- Slack test requires at least one webhook configured (SLACK_WEBHOOK_URL or SLACK_WEBHOOK_SIGNALS/CRITICAL/HEALTH/DAILY); otherwise status shows last_send_ok: false and message "Slack not configured".
- Force evaluation uses the same trigger_evaluation path as the scheduler; when market is closed it still runs (intended for testing).

---

## File list

- `chakraops/app/api/notifications_store.py` — state events, append_archive, append_delete, archive_all; load_notifications(state_filter, state/updated_at).
- `chakraops/app/api/ui_routes.py` — GET notifications?state=; POST archive, DELETE delete, POST archive_all; _get_slack_status_health; system-health slack + last_skip_reason; POST admin/slack/test, POST admin/evaluation/force.
- `chakraops/app/core/alerts/slack_status.py` — New: get_slack_status, update_slack_status.
- `chakraops/app/core/alerts/slack_notifier.py` — Call update_slack_status on send.
- `chakraops/app/api/server.py` — _last_scheduled_skip_reason; _run_scheduled_evaluation sets skip reason; get_scheduler_status returns last_skip_reason.
- `chakraops/tests/test_ui_r21_5_notifications_slack_scheduler.py` — New: 7 tests.
- `frontend/src/api/types.ts` — UiSystemHealthScheduler.last_skip_reason; UiSystemHealthSlack; UiSystemHealthResponse.slack.
- `frontend/src/api/queries.ts` — notifications path(state); archive/delete/archive_all paths and hooks; useNotifications(limit, state); useAdminSlackTest, useAdminEvaluationForce.
- `frontend/src/pages/NotificationsPage.tsx` — Tabs, Archive all, per-row and detail actions.
- `frontend/src/components/NotificationBell.tsx` — NEW count, list NEW, Ack/Archive.
- `frontend/src/pages/SystemDiagnosticsPage.tsx` — Slack card, last_skip_reason, Send test Slack, Force evaluation now.
- `frontend/src/pages/NotificationsPage.test.tsx` — Phase 21.5 tabs and actions.
- `frontend/src/pages/SystemDiagnosticsPage.test.tsx` — Slack, last_skip_reason, admin buttons.

---

## R21.5.1 addendum — Slack multi-channel + scheduler heartbeat

**Date:** 2026-02-17  
**Goal:** Make dashboard trustable: per-channel Slack status and test; scheduler tick audit; evaluation alerts route to correct channel.

### Slack multi-channel

- **Status store:** `out/slack_status.json` now has `channels: { signals: {...}, daily: {...}, data_health: {...}, critical: {...} }` plus `last_any_send_at`, `last_any_send_ok`, `last_any_send_error` for quick display.
- **Channel mapping:** signals ← eligibility/entry/exit (SIGNAL, POSITION_ENTRY, POSITION_SCALE_OUT, POSITION_EXIT, POSITION_HOLD); data_health ← DATA_HEALTH, PORTFOLIO_RISK_WARN, SYSTEM, REGIME_CHANGE; critical ← POSITION_ABORT, PORTFOLIO_RISK_BLOCK, POSITION_EXIT (STOP_LOSS/CRITICAL); daily ← test only for now.
- **Backend:** `get_webhook_for_channel(channel)` in slack_dispatcher (signals/daily/data_health/critical); SLACK_WEBHOOK_URL defaults to signals. SlackNotifier routes alerts by `_channel_for_alert(alert)` and updates per-channel status.
- **Admin test:** `POST /api/ui/admin/slack/test?channel=signals|daily|data_health|critical`; response includes `channel`, `ok`, `message`, `updated_status` (full slack status).
- **Frontend:** System Status Slack card shows per-channel last_send_at, last_send_ok, last_error; four buttons: "Test signals", "Test daily", "Test data health", "Test critical".

### Scheduler heartbeat

- **Backend:** `get_scheduler_status()` and system-health now include `last_duration_ms`, `last_run_ok`, `last_run_error`, `run_count_today`. Scheduler loop logs one line per tick: `[SCHEDULER] tick run_id=... skip_reason=... duration_ms=...`.
- **Frontend:** Scheduler card shows last_duration_ms, last_run_ok, last_run_error, run_count_today when present.

### Evaluation → Slack

- No change to decision JSON. Alerts built in alert_engine are sent via SlackNotifier; each alert is routed to the channel above (signals/data_health/critical). Real evaluation alerts now post to the correct channel when webhooks are configured.

### Tests

- Backend: `test_ui_admin_slack_test_per_channel`, `test_scheduler_status_includes_r21_51_fields`, `test_ui_system_health_scheduler_r21_51_fields`; system-health asserts slack.channels.
- Frontend: SystemDiagnosticsPage asserts 4 Slack test buttons and mock scheduler/slack with new fields.
- Frontend build fixes: `useAckNotification(_limit)` to avoid unused param; UniversePage TableCell wrap with div for onClick (no TableCell onClick prop).

### File list (R21.5.1)

- `chakraops/app/core/alerts/slack_status.py` — Per-channel status; channels map; last_any_send_*.
- `chakraops/app/core/alerts/slack_dispatcher.py` — get_webhook_for_channel; get_test_webhook_url includes SLACK_WEBHOOK_URL.
- `chakraops/app/core/alerts/slack_notifier.py` — _channel_for_alert; _webhook_for_alert uses get_webhook_for_channel; update_slack_status(channel, ...).
- `chakraops/app/api/server.py` — _last_scheduled_duration_ms, _last_scheduled_run_error, _scheduler_run_count_today, _scheduler_run_count_date; _run_scheduled_evaluation logs one line per tick and sets new fields; get_scheduler_status returns them.
- `chakraops/app/api/ui_routes.py` — POST admin/slack/test?channel=; system-health scheduler last_duration_ms, last_run_ok, last_run_error, run_count_today.
- `chakraops/tests/test_ui_r21_5_notifications_slack_scheduler.py` — 3 new tests.
- `frontend/src/api/types.ts` — UiSystemHealthSlackChannel; UiSystemHealthSlack.channels, last_any_send_*; UiSystemHealthScheduler R21.5.1 fields.
- `frontend/src/api/queries.ts` — useAdminSlackTest(channel); uiAdminSlackTestPath(channel); useAckNotification(_limit).
- `frontend/src/pages/SystemDiagnosticsPage.tsx` — 4 Slack test buttons; per-channel status; scheduler new fields.
- `frontend/src/pages/UniversePage.tsx` — TableCell wrap div for Remove button (fix TS/invalid prop).
