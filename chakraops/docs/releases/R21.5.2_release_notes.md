# Release R21.5.2 — Evaluation heartbeat/summary Slack post (daily channel)

**Date:** 2026-02  
**Goal:** After every completed evaluation cycle (scheduler or Force), send exactly one Slack message of type EVAL_SUMMARY to the daily channel so the user can trust the scheduler without manually clicking Run Evaluation.

---

## Scope

- **In scope:** One EVAL_SUMMARY Slack post per completed run to channel `daily` (SLACK_WEBHOOK_DAILY); payload built from run/artifact only (no new ORATS); throttle option `EVAL_SUMMARY_EVERY_N_TICKS` for scheduler runs; `slack_status.json` channels.daily updated with `payload_type=EVAL_SUMMARY`.
- **Out of scope:** Decision JSON changes; changes to signals/data_health/critical routing (unchanged).

---

## Behavior

1. **When:** After every completed evaluation cycle — both scheduler ticks that actually started a run and "Force evaluation now".
2. **Where:** Message is sent to channel `daily` (uses `SLACK_WEBHOOK_DAILY`). If not configured, no crash; `slack_status.channels.daily` is updated with `last_send_ok=false`, `last_error="Slack not configured"`.
3. **Content (concise):** mode (LIVE/MOCK), run_id, timestamp; counts (total, eligible, A-tier, B-tier, blocked); top 3 eligibles with strategy and score/band; alerts emitted by channel in this run (if available); duration_ms and last_run_ok. No new ORATS calls — data from run result / decision artifact only.
4. **Throttle:** Env/config `EVAL_SUMMARY_EVERY_N_TICKS` (default 1). If set to 2/3/4, only every Nth scheduler-started run sends the summary. Throttle applies to scheduler runs only; "Force evaluation now" always sends.
5. **Status:** `out/slack_status.json` uses existing per-channel model (R21.5.1); `channels.daily.last_payload_type` is set to `EVAL_SUMMARY` after send.

---

## Implementation

- **New:** `app/core/alerts/eval_summary.py` — `build_eval_summary_payload()`, `set_scheduler_tick_for_run()` / `get_scheduler_tick_for_run()`, `should_send_eval_summary_this_run()`.
- **SlackNotifier:** `send_eval_summary(channel="daily", payload)` — sends formatted message, updates `slack_status` with `payload_type="EVAL_SUMMARY"`.
- **Hook:** `process_run_completed()` in alert_engine builds payload, checks throttle, calls `notifier.send_eval_summary("daily", payload)`.
- **Scheduler:** When a run is started by the scheduler, `set_scheduler_tick_for_run(run_id, tick)` is called in server so throttle can be applied when the run completes.

---

## Tests

- **test_eval_summary_r2152.py:** (1) After mocked evaluation completion, `send_eval_summary` is called once for daily with payload_type EVAL_SUMMARY and slack_status.channels.daily is updated. (2) With `EVAL_SUMMARY_EVERY_N_TICKS=2`, only every second scheduler tick sends (tick 1 → no send, tick 2 → send); Force run (no tick) always sends.

---

## Verification

- Manual: Leave server running; receive periodic EVAL_SUMMARY posts in #chakraops-daily even when no symbols are eligible.
- Signals / data_health / critical channels receive only their routed alerts, unchanged.
- See `out/verification/R21.5.2/notes.md` for commands and evidence.
