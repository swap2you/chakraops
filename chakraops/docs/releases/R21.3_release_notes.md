# Release R21.3 — Universe add/remove via UI (Phase 21.3)

**Date:** 2026-02-19  
**Goal:** Universe Manager on Universe page: add/remove symbols via overlay file; no CSV mutation; single source of truth for evaluation.

---

## Scope

- **In scope:** Overlay file `out/universe_overrides.json`; GET/POST/DELETE `/api/ui/universe/symbols`, POST `/api/ui/universe/reset`; validation (1–10 chars, [A-Z0-9.-]); frontend Add symbol form, Remove per row, counts (base/added/removed/total); evaluation uses effective list.
- **Out of scope:** Editing CSV; multi-user or role-based reset; decision JSON format (unchanged).

---

## API changes

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/ui/universe/symbols` | Returns `{ base_count, overlay_added_count, overlay_removed_count, symbols: string[] }`. |
| POST | `/api/ui/universe/symbols` | Body `{ symbol }`. Adds to overlay, removes from `removed` if present. Returns `{ symbol, symbols }`. |
| DELETE | `/api/ui/universe/symbols/{symbol}` | Adds symbol to overlay.removed, removes from overlay.added. Returns `{ removed, symbols }`. |
| POST | `/api/ui/universe/reset` | Clears overlay. Returns `{ reset: true, symbols }`. |

All require `x-ui-key` when `UI_API_KEY` is set.

---

## Overlay file

- **Location:** `out/universe_overrides.json` (or `get_output_dir()` / `universe_overrides.json`).
- **Format:** `{ "added": ["SYM"], "removed": ["SYM"], "updated_at": "ISO8601" }`.
- **Effective universe:** `(CSV base ∪ added) − removed`, stable sorted. Evaluation and GET `/api/ui/universe/symbols` use this list.

---

## UI changes

- **Universe page:** "Universe Manager" card with base/added/removed/total counts; Add symbol input (1–10 chars) + Add button; validation message for invalid input. Table shows effective symbols (artifact data merged when available); each row has Remove button (with confirm). Newly added symbols appear in the list immediately; they are included in the next evaluation run.

---

## Tests added

- **Backend:** `chakraops/tests/api/test_ui_universe_r21_3.py` — GET structure; POST add → appears in GET; DELETE remove → disappears; validation 400 for invalid; duplicate add idempotent; remove then add flips; POST reset clears overlay. Uses isolated temp overlay path.
- **Frontend:** `UniversePage.test.tsx` — mocks for `useUniverseSymbols`, `useUniverseAddSymbol`, `useUniverseRemoveSymbol`; "renders Add symbol form"; "Add triggers hook"; "Remove triggers hook"; "invalid add shows validation message".

---

## Manual verification steps

1. Open Universe page; confirm Universe Manager card shows counts and Add symbol input.
2. Add a symbol (e.g. NVDA); confirm it appears in the table and in GET `/api/ui/universe/symbols` response.
3. Remove a symbol (e.g. one from base); confirm it disappears from table and from GET response.
4. Run evaluation; confirm effective universe (including overlay) is used (e.g. added symbol is evaluated).
5. (Optional) POST `/api/ui/universe/reset`; confirm overlay cleared and symbols = base only.

---

## Decision JSON

- **Unchanged.** No changes to `decision_latest.json` or archived decision persistence; no `reasons_explained` or human text persisted. Verified by: no edits to `evaluation_store_v2`, `decision_artifact_v2`, or any decision write path; overlay only affects symbol list input to evaluation.

---

## File list

- `chakraops/docs/enhancements/phase_21_account_portfolio.md` — Phase 21.3 updated (R21.3 req v1.1), acceptance criteria checked.
- `chakraops/app/core/universe/universe_overrides.py` — New: load/save overlay, validate_symbol, get_effective_symbols, add_symbol, remove_symbol, reset_overlay.
- `chakraops/app/api/data_health.py` — get_base_universe_symbols(); get_universe_symbols() uses get_effective_symbols(base).
- `chakraops/app/api/ui_routes.py` — GET/POST/DELETE `/universe/symbols`, POST `/universe/reset`.
- `chakraops/tests/api/test_ui_universe_r21_3.py` — New: 7 API tests.
- `frontend/src/api/types.ts` — UniverseSymbolsResponse.
- `frontend/src/api/queries.ts` — Paths, query key, useUniverseSymbols, useUniverseAddSymbol, useUniverseRemoveSymbol, useUniverseReset.
- `frontend/src/pages/UniversePage.tsx` — Universe Manager card, add form, merged effective + artifact table, Remove per row.
- `frontend/src/pages/UniversePage.test.tsx` — Mocks and 4 Phase 21.3 tests.
