# Release R21.2 — CSP realized PnL sign + position math (Phase 21.2)

**Date:** 2026-02-17  
**Goal:** Correct realized PnL sign for options using explicit position_side (SHORT/LONG) and option_side (PUT/CALL); normalize per-share vs total dollars; ensure UI shows corrected values.

---

## Scope

- **In scope:** Realized PnL formulas (SHORT: entry_credit - close_debit; LONG: close_credit - entry_debit), position_side/option_side on Position model, per-share normalization for entry credit, unit tests with fixed numbers, portfolio realized total = sum of position realized.
- **Out of scope:** Decision JSON changes (unchanged), fees modeling beyond existing open_fees/close_fees (already subtracted when present).

---

## What changed

### Backend

- **`app/core/positions/realized_pnl.py`** (new): `compute_realized_pnl_short_option`, `compute_realized_pnl_long_option`, `compute_realized_pnl`, `normalize_open_credit_to_total`. Convention: amounts in total dollars; per-share values &lt; 100 normalized to total via × 100 × contracts.
- **`app/core/positions/models.py`:** Added `position_side` (SHORT|LONG). Defaults: CSP/CC → position_side=SHORT; CSP → option_type=PUT, CC → option_type=CALL. to_dict/from_dict include `position_side`.
- **`app/core/positions/service.py`:** `close_position` uses `realized_pnl.compute_realized_pnl` and `normalize_open_credit_to_total`; SHORT formula: entry_credit_total - close_debit_total - fees.
- **`app/core/positions/store.py`:** `allowed_keys` includes `position_side`, `option_type` for updates.

### Tests

- **`tests/_core/test_realized_pnl_r21.py`** (new): SHORT 9.40/4.50 → 490, with fees, LONG 400/500 → 100, normalization (per-share vs total), deterministic.
- **`tests/test_ui_routes.py`:** `test_ui_positions_close_csp_per_share_realized_pnl_positive` (entry 9.40, close 4.50 → +490); `test_ui_portfolio_realized_total_equals_sum_of_closed_positions` (150 + 490 = 640).

### UI

- No frontend code changes. Portfolio and position rows already read `realized_pnl` and `realized_pnl_total` from API; backend now returns corrected values.

---

## Tests added/updated

- 11 unit tests in `test_realized_pnl_r21.py`.
- 2 API/flow tests: close CSP per-share → +490; portfolio metrics sum = sum of closed position realized.

---

## Manual verification steps

1. Create a CSP position with credit_expected = 9.40 (per-share), 1 contract.
2. Close with close_price = 4.50. Confirm position shows realized_pnl = +490 (or 490 - fees if fees set).
3. Portfolio metrics: realized_pnl_total should equal sum of all closed positions’ realized_pnl.
4. NVDA (or any) CSP closed with credit open &gt; debit close should show positive realized PnL in UI.

---

## Known issues

- None. Pre-existing test failures (portfolio_risk, store guardrails) are unrelated to R21.2.

---

## File list

- `chakraops/app/core/positions/realized_pnl.py`
- `chakraops/app/core/positions/models.py`
- `chakraops/app/core/positions/service.py`
- `chakraops/app/core/positions/store.py`
- `chakraops/tests/_core/test_realized_pnl_r21.py`
- `chakraops/tests/test_ui_routes.py` (2 new tests)
