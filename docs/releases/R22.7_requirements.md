# R22.7 â€” Truth + Consistency + Premium Symbol UX

**Release:** R22.7  
**Date:** 2026-02  
**Goal:** Fix decision artifact pollution, run vs recompute consistency, MTF S/R correctness, targets/hold-time clarity, shares capture, ORATS/notification labels, trade ticket contract identity, and premium UX polish.

---

## Objectives

1. **Decision artifact hygiene (P0):** Persisted decision JSON is code-only: no human prose, no UI strings, no raw `FAIL_*`/`WARN_*` in values. Replace with machine codes (e.g. `primary_reason_codes`, `gate_fail_codes`). Human text only at request time.
2. **Run eval vs recompute determinism (P0):** Universe run and single-symbol recompute use the same pipeline and inputs; results (score, band, verdict, reason_codes) match for the same symbol.
3. **MTF Support/Resistance (P0):** Daily/weekly/monthly levels computed from distinct resampled OHLC; not reusing daily for all timeframes.
4. **Targets + hold-time (P1):** Targets directionally sensible vs spot/SR; hold-time ATR-based with clear tooltip; no nonsensical targets without a code.
5. **Shares tab + holdings (P1):** Symbol page Shares tab; record shares position (qty, avg cost, account); show in Portfolio/Holdings.
6. **Technical details + score breakdown (P1):** Indicators and score components visible (request-time only); missing indicators clearly "not used."
7. **Notifications + ORATS labels (P1):** ORATS status OK/DELAYED/WARN/ERROR with safe UI labels; no raw "ORATS WARN" in notifications.
8. **Trade ticket contract identity (P0):** Options candidates always carry `contract_key` and/or `option_symbol`; no "contract identity required" error when opening ticket.
9. **Premium UX polish (P2):** Full-width MTF and Targets cards; subtle animations; consistent badge colors; info tooltips for ATR, MTF SR, score breakdown.

---

## Scope

- **In scope:** All items above; schema refactor for decision artifact (code-only); unified eval path; MTF resampling; request-time explanations; shares position capture; notification code mapping; contract identity guarantee; UI polish.
- **Out of scope:** New strategy rules; changes to core scoring weights beyond correctness fixes; new Slack channels or payload types.

---

## Non-goals

- Strategy redesign or new entry/exit rules.
- Persisting human prose or UI strings in decision JSON.
- New persistence outside `out/` allowlist.

---

## Acceptance criteria

| ID | Criterion | Status (R22.7 completion) |
|----|-----------|----------------------------|
| A1 | Decision JSON has no keys: `why_this_trade`, `explanation` (prose), `label`, `tooltip`, `message`, `reasons_explained`, `panel`, `display_*` (prose). | Done (Part 1.1) |
| A2 | Decision JSON has no string values matching `\bFAIL_[A-Z0-9_]+\b` or `\bWARN_[A-Z0-9_]+\b` or known UI snippets. | Done (Part 1.1) |
| A3 | Persisted reason/gate data uses `primary_reason_codes`, `gate_status_codes`, `gate_fail_codes` (machine codes, no FAIL_ prefix in persisted values). | Done (Part 1.1) |
| A4 | Universe eval and single-symbol recompute for same symbol yield identical score, band, verdict, reason_codes under same data. | Done (Part 2: same pipeline + determinism test; As-of/Inputs for verification) |
| A5 | MTF S/R: weekly/monthly from resampled OHLC; not identical to daily unless data coincidence. | Done (Part 3: real resampling + bar_count + coincide message) |
| A6 | Targets/hold-time: directionally sensible vs spot; ATR hold-time tooltip; insufficient_data when ATR missing. | Partial (existing) |
| A7 | Shares tab on Symbol page; Add Shares Position; Portfolio shows shares positions. | Partial (existing) |
| A8 | Notifications show safe ORATS labels (no raw WARN/FAIL). | Partial (existing) |
| A9 | Trade ticket opens for options candidates without contract identity error. | Done (Part 1.1: contract_key derived when missing) |
| A10 | MTF and Targets cards full-width; info tooltips for ATR, MTF SR, score breakdown. | Partial (existing) |

---

## Test plan

- **Backend:** `test_decision_artifact_hygiene_r227.py`; run vs recompute consistency test; contract identity test; ORATS code storage.
- **Frontend:** Symbol page (MTF, Targets, Shares tab); notifications safe labels; Trade Ticket; score breakdown and tooltips.
- **Gate:** pytest; npm test; npm run build.

---

## UAT checklist (tickers)

For each of NVDA, AMD, AAPL, AMZN, NKE, HD, WMT: Universe eval matches recompute; MTF SR not trivially identical; targets sensible; hold-time tooltip; no raw FAIL_*/WARN_*; Trade ticket opens; Shares tab and Add shares position.

---

## Rollback plan

Revert R22.7 commit(s). No DB migration if only JSON/API shapes changed. If new tables added, document rollback (drop table or ignore).

---

## References

- Phase 22: `docs/enhancements/phase_22_trading_intelligence_and_prod_readiness.md`
- Decision store: `docs/DECISION_STORE_CANONICAL.md`
- Release checklist: `docs/releases/RELEASE_CHECKLIST.md`
